<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>VIM: usr_11</title>
<link rel="stylesheet" href="vim-stylesheet.css" type="text/css">
</head>
<body>
<div id=banner>
<a href="help.html">幫助總覽</a> &middot;
<a href="quickref.html">快速參考</a> &middot;
<a href="index.html">命令索引</a> &middot;
<a href="usr_toc.html">用戶手冊</a> &middot;
<a href="help.html#reference_toc">參考手冊</a>
</div>

<div id=outer>
<h2>usr_11</h2>
<pre>
<b class="vimtag"> <a name="usr_11.txt">usr_11.txt</a> </b>    For Vim version 8.0.  最近更新: 2010年7月

                     <code class="vim">VIM 用戶手冊 - by Bram Moolenaar</code>
                     <code class="vim">譯者</code>: Nek_in http://vimcdoc.sf.net

                              從崩潰中恢復


你的計算機崩潰過嗎？是不是還正好在你編輯了幾個小時以後？不要驚慌！Vim 已經保存
了大部分的信息使你可以恢復你的大多數數據。本章告訴你怎樣恢復這些數據並向你介紹
Vim 是如何處理交換文件的。

 <a href="usr_11.html#11.1">11.1</a>   基本恢復
 <a href="usr_11.html#11.2">11.2</a>   交換文件在哪
 <a href="usr_11.html#11.3">11.3</a>   是不是崩潰了？
 <a href="usr_11.html#11.4">11.4</a>   深入閱讀

     下一章:  <a href="usr_12.html#usr_12.txt">usr_12.txt</a>   小竅門
     前一章:  <a href="usr_10.html#usr_10.txt">usr_10.txt</a>   做大修改
       目錄:  <a href="usr_toc.html#usr_toc.txt">usr_toc.txt</a> 

</pre><hr class="doubleline" /><pre>
<h4><b class="vimtag"> <a name="11.1">11.1</a> </b>  基本恢復</h4>
在大多數情況下，恢復一個文件相當簡單。假設你知道正在編輯的是哪個文件 (並且硬盤
沒壞的話)。可以用 "-r" 選項啟動 Vim:

<code class="example">        vim -r help.txt</code>
<code class="example"></code>
Vim 會讀取交換文件 (用於保存你的編輯數據的文件) 並且提取原文的編輯碎片。如果
Vim 恢復了你的改變，你會看到如下文字 (當然了，文件名會不一樣):

<code class="section">        Using swap file ".help.txt.swp" </code>
<code class="section">        Original file "~/vim/runtime/doc/help.txt" </code>
<code class="section">        Recovery completed. You should check if everything is OK. </code>
<code class="section">        (You might want to write out this file under another name </code>
<code class="section">        and run diff with the original file to check for changes) </code>
<code class="section">        You may want to delete the .swp file now. </code>

        (<code class="vim">譯者注</code>: 中文情況下是:
<code class="section">        使用交換文件 ".help.txt.swp"</code>
<code class="section">        原文件 "~/vim/runtime/doc/help.txt"</code>
<code class="section">        恢復完成。請確定一切正常。 </code>
<code class="section">        (你可能想要把這個文件另存為別的文件名，</code>
<code class="section">        再執行 diff 與原文件比較以檢查是否有改變)</code>
<code class="section">        現在可以刪除 .swp 文件。</code>
        )

為了安全起見，可以用另一個文件名保存這個文件:

<code class="example">        :write help.txt.recovered</code>
<code class="example"></code>
可以把這個文件與原文件作一下比較，看看恢復的效果如何。這方面 Vimdiff 可以幫很
大的忙 (參見  <a href="usr_08.html#08.7">08.7</a> )。例如: 
<code class="example"></code>
<code class="example">        :write help.txt.recovered</code>
<code class="example">        :edit #</code>
<code class="example">        :diffsp help.txt</code>
<code class="example"></code>
<code class="note">注意</code>用一個比較新的原文件來比較 (你在計算機崩潰前最後保存過的文件)，並且檢查有
沒有東西丟失了 (由於某些問題導致 Vim 無法恢復)。
    如果在恢復的過程中 Vim 顯示出一些警告信息，<code class="note">注意</code>小心閱讀。這應該是很少見
的。

如果恢復產生的文件和文件內容完全一致，你會看到以下消息:

<code class="section">        Using swap file ".help.txt.swp" </code>
<code class="section">        Original file "~/vim/runtime/doc/help.txt" </code>
<code class="section">        Recovery completed. Buffer contents equals file contents. </code>
<code class="section">        You may want to delete the .swp file now. </code>

通常這是因為你已經恢復過改變，或者修改後寫入了文件。此時刪除交換文件應該安全。

最後所做的一些修改不能恢復是正常的。Vim 在你停止大約 4 秒不輸入的時候或者輸入
大約兩百個字符以後才會更新交換文件。這間可以通過 <a href="options.html#'updatetime'">'updatetime'</a> 和 <a href="options.html#'updatecount'">'updatecount'</a>
兩個選項來調整。這樣，如果系統崩潰前 Vim 沒有更新交換文件，最後一次更新後編輯
的內容就會丟失。

如果你編輯的時候沒有給定文件名，可以用一個空的字符串來表示文件名:

<code class="example">        vim -r ""</code>
<code class="example"></code>
你需要進入原來的目錄執行這個命令，否則 Vim 是找不到這個交換文件的。

</pre><hr class="doubleline" /><pre>
<h4><b class="vimtag"> <a name="11.2">11.2</a> </b>  交換文件在哪</h4>
Vim 可以把交換文件保存在幾個不同的地方。通常是原文件所在的目錄。要知道這一點，
進入該目錄，然後輸入:

<code class="example">        vim -r</code>
<code class="example"></code>
Vim 會列出所有它能找到的交換文件。它還會從其它目錄尋找本目錄文件的交換文件，但
它不會尋找其它目錄裡的交換文件，更不會遍及整個目錄樹。
    這個命令的輸出如下:

<code class="section">        Swap files found: </code>
<code class="section">           In current directory: </code>
<code class="section">        1.    .main.c.swp </code>
<code class="section">                  owned by: mool   dated: Tue May 29 21:00:25 2001 </code>
<code class="section">                 file name: ~mool/vim/vim6/src/main.c </code>
<code class="section">                  modified: YES </code>
<code class="section">                 user name: mool   host name: masaka.moolenaar.net </code>
<code class="section">                process ID: 12525 </code>
<code class="section">           In directory ~/tmp: </code>
<code class="section">              -- none -- </code>
<code class="section">           In directory /var/tmp: </code>
<code class="section">              -- none -- </code>
<code class="section">           In directory /tmp: </code>
<code class="section">              -- none -- </code>

        (<code class="vim">譯者</code>: 中文的情形如下:
<code class="section">        找到以下交換文件:</code>
<code class="section">           位於當前目錄:</code>
<code class="section">        1.    .main.c.swp </code>
<code class="section">                    所有者: mool    日期: Tue May 29 21:00:25 2001 </code>
<code class="section">                    文件名: ~mool/vim/vim6/src/main.c </code>
<code class="section">                    修改過: 是 </code>
<code class="section">                    用戶名: mool     主機名: masaka.moolenaar.net </code>
<code class="section">                   進程 ID: 12525 </code>
<code class="section">           位於目錄 ~/tmp:</code>
<code class="section">                -- 無 --</code>
<code class="section">           位於目錄 /var/tmp:</code>
<code class="section">                -- 無 --</code>
<code class="section">           位於目錄 /tmp:</code>
<code class="section">                -- 無 --</code>
        )

如果有幾個交換文件，其中一個可能是你要的，Vim 會給出一個文件列表，你需要輸入一
個表示這個文件的數字。小心檢查那幾個文件的時間，並確定哪一個才是你需要的。
  萬一你不知道是哪個的話，一個一個試一試。


使 用 指 定 的 交 換 文 件

如果你知道要用哪個文件，你可以指定交換文件的名字。Vim 會找出交換文件所對應的原
始文件的名字。

例如: 
<code class="example">        Vim -r .help.txt.swo</code>
<code class="example"></code>
這個方法在交換文件在一個非預期的目錄中時很有用。Vim 知道 *.s[uvw][a-z] 模式的
文件是交換文件。

如果這還不行，看看 Vim 報告的文件名是什麼，然後根據需要給文件換名。根據
<a href="options.html#'directory'">'directory'</a> 選項的值你可以知道 Vim 會把交換文件放到什麼地方。

        <code class="note">備註</code>:
        Vim 在 <a href="options.html#'dir'">'dir'</a> 選項指定的目錄中尋找名為 "filename.sw?" 的交換文件。如果
        通配符不能正常工作 (例如 <a href="options.html#'shell'">'shell'</a> 選項不正確)，Vim 轉而嘗試文件
        "filename.swp"。如果仍失敗，你就只能通過給定交換文件的名稱來恢復原來的
        文件了。

</pre><hr class="doubleline" /><pre>
<h4><b class="vimtag"> <a name="11.3">11.3</a> </b>  是不是崩潰了？                           <b class="vimtag"> <a name="ATTENTION">ATTENTION</a> </b>    <b class="vimtag"> <a name="E325">E325</a> </b></h4>
Vim 盡可能保護你不要做傻事。有時你打開一個文件，天真地以為文件的內容會顯示出
來。可是，Vim 卻給出一段很長的信息:

<code class="section">                E325: ATTENTION </code>
<code class="section">        Found a swap file by the name ".main.c.swp" </code>
<code class="section">                  owned by: mool   dated: Tue May 29 21:09:28 2001 </code>
<code class="section">                 file name: ~mool/vim/vim6/src/main.c </code>
<code class="section">                  modified: no </code>
<code class="section">                 user name: mool   host name: masaka.moolenaar.net </code>
<code class="section">                process ID: 12559 (still running) </code>
<code class="section">        While opening file "main.c" </code>
<code class="section">                     dated: Tue May 29 19:46:12 2001 </code>
<code class="section"> </code>
<code class="section">        (1) Another program may be editing the same file. </code>
<code class="section">            If this is the case, be careful not to end up with two </code>
<code class="section">            different instances of the same file when making changes. </code>
<code class="section">            Quit, or continue with caution. </code>
<code class="section"> </code>
<code class="section">        (2) An edit session for this file crashed. </code>
<code class="section">            If this is the case, use ":recover" or "vim -r main.c" </code>
<code class="section">            to recover the changes (see ":help recovery"). </code>
<code class="section">            If you did this already, delete the swap file ".main.c.swp" </code>
<code class="section">            to avoid this message. </code>

        (<code class="vim">譯者注</code>: 翻譯成中文如下:

<code class="section">                E325: <code class="note">注意</code></code>
<code class="section">         發現交換文件 "main.c.swp" </code>
<code class="section">             所有者: mool     日期: 2001年5月29日 星期二 21:09:28</code>
<code class="section">             文件名: ~mool/vim/vim6/src/main.c</code>
<code class="section">             修改過: 否</code>
<code class="section">             用戶名: mool   主機名: masaka.moolenaar.net</code>
<code class="section">             進程號: 12559 (仍在運行) </code>
<code class="section">         正在打開文件 "main.c" </code>
<code class="section">               日期: 2001年5月29日 星期二 19:46:12</code>
<code class="section"></code>
<code class="section">        (1) 另一個程序可能也在編輯同一個文件。</code>
<code class="section">            如果是這種情況，修改時請<code class="note">注意</code>避免同一個文件產生兩個不同的版本。 </code>
<code class="section">            </code>
<code class="section">            退出，或小心地繼續。</code>
<code class="section"></code>
<code class="section">        (2) 上次編輯此文件時崩潰。</code>
<code class="section">            如果是這樣，請用 ":recover" 或 "vim -r main.c" </code>
<code class="section">            恢復修改的內容 (請見 ":help recovery")。</code>
<code class="section">            如果你已經進行了恢復，請刪除交換文件 ".main.c.swp" </code>
<code class="section">            以避免再看到此消息。</code>

        )

你遇到這個信息是因為 Vim 發現你編輯的文件的交換文件已經存在。這一定是有什麼地
方出問題了。可能的原因有兩個:

1. 這個文件正在被另一個進程編輯。<code class="note">注意</code>有 "process ID" 那行。它看起來是這樣的:

<code class="section">                process ID: 12559 (still running) </code>

    "still running" 表示同一台計算機上有一個進程正在編輯這個文件。在非 Unix 的
    系統上你不會得到這個信息。而如果你通過網絡編輯這個文件，可能也得不到這個信
    息，因為那個進程不在你的機器上。在這兩種情況下，你要自己找到原因。
       如果另一個 Vim 正在編輯這個文件，繼續編輯會導致同一個文件有兩個版本。最
    後存盤的文件會覆蓋前一個版本。這樣的結果是一些編輯數據丟失了。這種情況下，
    你最好退出這個 Vim。

2. 交換文件可能是由於前一次 Vim 或者計算機崩潰導致的。檢查提示信息中的日期。如
   果交換文件比你正在編輯的文件新，而且出現這個信息:

<code class="section">                modified: YES </code>

   這就表明你很可能需要恢復了。
       如果文件的日期比交換文件新，可能是在崩潰後被修改過了 (也許你已經恢復
   過，只是沒有刪除交換文件？)，也可能文件在崩潰前保存過，但這發生在在最後一次
   寫入該交換文件之後 (那你運氣了，你根本不需要這個舊的交換文件)。Vim 會用如下
   語句提醒你:

<code class="section">      NEWER than swap file! </code>

      (<code class="vim">譯者注</code>: 意為 "文件比交換文件新")


無 法 讀 取 的 交 換 文 件

有時下面這樣的信息

<code class="section">        [cannot be read] </code>

<code class="section">        或 <code class="special">[無法讀取]</code> (中文信息，<code class="vim">譯者</code>)</code>

會出現在交換文件的文件名之下。這可好可壞，依情況而定。

如果上次編輯在作出任何修改前就崩潰了的話，是好事。這樣交換文件的長度為 0。你只
要刪除之然後繼續即可。

如果情況是你對交換文件沒有讀權限，就比較糟糕。你可能得以只讀方式瀏覽該文件。或
者退出。在多用戶系統中，如果你以別人的身份登錄並做了上一次修改，先退出登錄然後
以那個身份重新登錄可能會 "治癒" 該讀取錯誤。不然的話，你得找出是誰做的上一次修
改 (或正在修改)，然後和那個人聊聊。

如果情況是交換文件所在的磁盤物理性地損壞了，就非常糟糕了。幸運的是，這種情況幾
乎不會發生。
你可能需要以只讀方式查看文件 (如果允許的話)，看看到底有多少改動被 "忘記" 了。
如果你是改動文件的那個人，準備好重做你的改動。


怎 麼 辦？                                      <b class="vimtag"> <a name="swap-exists-choices">swap-exists-choices</a> </b>

如果 Vim 版本支持對話框，你可以從對話框的五個選擇中 (<code class="vim">譯者注</code>: 原文如此) 挑一
個:

<code class="section">  Swap file ".main.c.swp" already exists! </code>
<code class="section">  <code class="special">[O]</code>pen Read-Only, (E)dit anyway, (R)ecover, (Q)uit, (A)bort, (D)elete it: </code>

  (<code class="vim">譯者</code>: 含義是:
<code class="section">  交換文件 ".main.c.swp" 已經存在！</code>
<code class="section">  以只讀方式打開([O])，直接編輯((E))，恢復((R))，退出((Q))，中止((A))，刪除 </code>
<code class="section">交換文件((D)): </code>
  )

O  用只讀方式打開文件。當你只是想看看文件的內容，而不打算恢復它的時候用這個選
   項。你可能知道有人在編輯它，但你想看看它的內容，而不會修改它。

E  直接編輯。小心使用這個選擇！如果這個文件已經被另一個文件打開，你編輯它會導
   致它有兩個版本。Vim 已經警告過你了，安全比事後說對不起要好。

R  從交換文件中恢復文件。如果你知道交換文件中有新的東西，而你想恢復它，選擇這
   一項。

Q  退出。不再編輯該文件。在有另一個 Vim 編輯該文件的時候選這一項。
       如果你剛打開 Vim，這會退出 Vim。當你用多個窗口打開幾個文件，Vim 只會在
   第一個文件遇到交換文件的時候退出。如果你是通過編輯命令打開文件，該文件不會
   被載入，Vim 會回到原來的文件中。

A  中止。類似 (Q) 退出，但同時中止更多的命令。這在試圖加載一個編輯多個文件的腳
   本 (例如一個多窗口的會話) 時很有用。

D  刪除交換文件。當你能確定你不再需要它的時候選這一項。例如，它不包括修改的數
   據，或者你的文件比交換文件新。
       在 Unix 系統上，只有建立這個交換文件的進程不再運行，這個選擇才會出現。

如果沒有出現對話框 (你使用的 Vim 不支持對話框)，你只能手工處理。要恢復一個文
件，使用如下命令:

<code class="example">        :recover</code>
<code class="example"></code>
Vim 不是總能檢測到一個文件有交換文件的。當另一個會話把交換文件放到別的位置或者
在編輯另一台機器的文件的時候，雙方使用的交換文件路徑不一樣都會發生這個問題。所
以，不要老是等 Vim 來提醒你。

如果你確實不想看到這個信息，你可以在 <a href="options.html#'shortmess'">'shortmess'</a> 選項中加上 'A' 標誌位。不過一
般你不需要這樣做。

關於加密和交換文件關係的註釋，見  <a href="recover.html#:recover-crypt">:recover-crypt</a> 。

</pre><hr class="doubleline" /><pre>
<h4><b class="vimtag"> <a name="11.4">11.4</a> </b>  深入閱讀</h4>
 <a href="recover.html#swap-file">swap-file</a>      解釋交換文件在什麼地方創建以及名字是什麼。
 <a href="recover.html#:preserve">:preserve</a>      手工刷新交換文件
 <a href="recover.html#:swapname">:swapname</a>      查看當前文件的交換文件
<a href="options.html#'updatecount'">'updatecount'</a>   多少個鍵被敲下後執行一次交換文件刷新
<a href="options.html#'updatetime'">'updatetime'</a>    交換文件刷新後的超時時間
<a href="options.html#'swapsync'">'swapsync'</a>      交換文件刷新後是否執行磁盤同步
<a href="options.html#'directory'">'directory'</a>     列出用於保存交換文件的目錄
<a href="options.html#'maxmem'">'maxmem'</a>        寫入交換文件前的內存使用限制
<a href="options.html#'maxmemtot'">'maxmemtot'</a>     同上，當用於所有文件

</pre><hr class="doubleline" /><pre>
<h4></h4>下一章:  <a href="usr_12.html#usr_12.txt">usr_12.txt</a>   小竅門

版權: 參見  <a href="usr_01.html#manual-copyright">manual-copyright</a>   vim:tw=78:ts=8:ft=help:norl:
</pre>
<p><i>Generated by vim2html</i></p>
</div>
</body>
</html>
